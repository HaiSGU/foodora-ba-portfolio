<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View SQL</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    .sql-viewer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    .sql-viewer-title {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 240px;
    }

    .sql-viewer-title h1 {
      font-size: 22px;
      margin: 0;
    }

    .sql-viewer-sub {
      color: #666;
      margin: 6px 0 0 0;
      font-size: 13px;
    }

    .sql-toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .code-shell {
      border: 1px solid rgba(0,0,0,0.12);
      border-radius: 12px;
      overflow: hidden;
      background: #0b1020;
    }

    .code-topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.06);
      border-bottom: 1px solid rgba(255,255,255,0.08);
      color: rgba(255,255,255,0.85);
      font-size: 12px;
    }

    pre {
      margin: 0;
      padding: 14px 16px;
      overflow: auto;
      max-height: 72vh;
      line-height: 1.55;
      color: rgba(255,255,255,0.92);
      font-size: 13px;
      tab-size: 4;
      white-space: pre;
    }

    .hint {
      color: rgba(255,255,255,0.78);
    }

    .error {
      color: #ffb4b4;
    }

    .path-pill {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 4px 8px;
      border-radius: 999px;
    }

    .muted {
      opacity: 0.85;
    }
  </style>
</head>
<body>
  <div class="container" style="max-width: 1100px; padding-top: 40px;">
    <div class="sql-viewer-header">
      <div class="sql-viewer-title">
        <i class="fas fa-code" style="color: var(--accent, #667eea);"></i>
        <div>
          <h1>SQL Viewer</h1>
          <p class="sql-viewer-sub">Opens SQL in-browser so it doesn’t auto-download.</p>
        </div>
      </div>

      <div class="sql-toolbar">
        <button id="backBtn" class="btn btn-secondary" type="button"><i class="fas fa-arrow-left"></i> Back</button>
        <a id="downloadBtn" class="btn btn-primary" href="#" download><i class="fas fa-download"></i> Download</a>
        <button id="copyBtn" class="btn btn-outline" type="button"><i class="fas fa-copy"></i> Copy</button>
      </div>
    </div>

    <div class="code-shell">
      <div class="code-topbar">
        <div>
          <span class="muted">File:</span>
          <span id="filePill" class="path-pill">(none)</span>
        </div>
        <div id="status" class="hint">Loading…</div>
      </div>
      <pre id="code">Loading…</pre>
    </div>

    <div style="margin-top: 14px; color: #666; font-size: 13px;">
      Tip: If you want to run this in SSMS, download the file and execute it in your database.
    </div>
  </div>

  <script>
    function isSafeRelativePath(p) {
      if (!p) return false;
      if (p.includes('..')) return false;
      if (p.includes('\\')) return false;
      if (p.startsWith('/')) return false;
      if (p.includes(':')) return false;
      if (p.startsWith('http://') || p.startsWith('https://')) return false;
      return true;
    }

    const params = new URLSearchParams(window.location.search);
    const file = params.get('file');

    const codeEl = document.getElementById('code');
    const statusEl = document.getElementById('status');
    const filePillEl = document.getElementById('filePill');
    const downloadBtn = document.getElementById('downloadBtn');
    const backBtn = document.getElementById('backBtn');
    const copyBtn = document.getElementById('copyBtn');

    backBtn.addEventListener('click', () => {
      if (window.history.length > 1) window.history.back();
      else window.location.href = '../index.html';
    });

    async function loadSql() {
      if (!isSafeRelativePath(file)) {
        statusEl.textContent = 'Invalid file path.';
        statusEl.className = 'error';
        codeEl.textContent = 'Missing/invalid file path. Example:\n  pages/sql-viewer.html?file=projects/foodora-mvp/assets/sql/foodora_sql_showcase.sql';
        codeEl.className = 'error';
        return;
      }

      filePillEl.textContent = file;

      const url = '../' + file;
      downloadBtn.href = url;

      try {
        statusEl.textContent = 'Fetching…';
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error('HTTP ' + res.status);
        }
        const text = await res.text();
        codeEl.textContent = text;
        statusEl.textContent = 'Loaded';
      } catch (err) {
        statusEl.textContent = 'Failed to load';
        statusEl.className = 'error';
        codeEl.textContent = 'Could not load the SQL file. You can still download it.\n\nError: ' + (err && err.message ? err.message : String(err));
        codeEl.className = 'error';
      }
    }

    copyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(codeEl.textContent || '');
        statusEl.textContent = 'Copied';
        statusEl.className = 'hint';
        window.setTimeout(() => (statusEl.textContent = 'Loaded'), 900);
      } catch {
        statusEl.textContent = 'Copy failed';
        statusEl.className = 'error';
      }
    });

    loadSql();
  </script>
</body>
</html>
